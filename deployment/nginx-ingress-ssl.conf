# /etc/nginx/sites-enabled/exam-system-frontend
# Working configuration as of 2025-12-17
# LAYER 2: Unified Application Gateway
# Receives traffic from Layer 1
# Splits traffic to Next.js (Frontend) and FastAPI (Backend)
# Implements Real-time vs REST lanes

# WebSocket Helper
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

map $http_x_forwarded_proto $final_forwarded_proto {
    default $http_x_forwarded_proto;
    ''      $scheme;
}

upstream nextjs_upstream {
    server 127.0.0.1:3000;
    keepalive 64;
}

upstream fastapi_upstream {
    server gt-omr-api.gt:8000;
    keepalive 64;
}

# Rate Limiting
limit_req_zone $binary_remote_addr zone=frontend_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/s; # Increased for API

server {
    listen 80;
    listen [::]:80;
    server_name _;

    # --- REAL IP CONFIGURATION ---
    # Trust the internal networks where Layer 1 lives.
    # Allow Nginx to look inside X-Forwarded-For to find the real client IP.

    # Trust local private ranges
    set_real_ip_from 10.10.24.0/22; # All servers lives on this subnet
    #set_real_ip_from 172.16.0.0/12;
    #set_real_ip_from 192.168.0.0/16;

    # Use the header built by Layer 1 / Cloudflare
    real_ip_header X-Forwarded-For;

    # Recursive on: Ignore trusted IPs (Layer 1) at the end of the chain
    # and pick the last UNTRUSTED IP (The User or Cloudflare Edge).
    real_ip_recursive on;

    # Global Proxy Headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $final_forwarded_proto;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    access_log /var/log/nginx/layer2-gateway.access.log;
    error_log /var/log/nginx/layer2-gateway.error.log;

    client_max_body_size 500M;

    # --- LANE 1: Real-time API (Streaming/Uploads) ---
    # Matches /api/realtime/ and rewrites to /api/
    location ~ ^/api/realtime/(.*)$ {
        # Limit Burst
        limit_req zone=api_limit burst=50 nodelay;

        # Rewrite URL: /api/realtime/batches -> /api/batches
        rewrite ^/api/realtime/(.*)$ /api/$1 break;

        proxy_pass http://fastapi_upstream;

        # OPTIMIZATION: Disable Buffering for Streams
        proxy_request_buffering off;
        proxy_buffering off;

        # EXTENDED TIMEOUTS
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 75s;

        proxy_cache_bypass $http_upgrade;
    }

    # --- LANE 2: Standard REST API (Default) ---
    # Matches /api/
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://fastapi_upstream;

        # Standard Buffering (Valid for small JSON responses)
        # Nginx default buffering is ON, which is good for storage/network efficiency

        # Standard Timeouts
        proxy_read_timeout 60s;

        proxy_cache_bypass $http_upgrade;
    }

    # --- INTERNAL VIDEO STREAMING ---
    # This location is NOT accessible directly by the browser.
    # It can only be reached via internal redirect from Next.js
    location /protected_videos/ {
        internal;
        alias /cephfs/omr/tutorials/; # <--- UPDATE THIS to your actual CephFS mount path

        # Optimization for video delivery
        aio threads;           # Use asynchronous I/O if available
        directio 512;          # Optimization for large files
        output_buffers 1 2M;   # Optimize buffer for streaming
        sendfile on;           # Zero-copy file transfer
        sendfile_max_chunk 512k;

        # Allow video seeking
        add_header Accept-Ranges bytes; 
        
        # Don't cache video files in Nginx proxy cache (too large)
        proxy_max_temp_file_size 0;
    }

    # --- NEXT.JS ROUTES ---
    location /_next/static {
        proxy_cache STATIC;
        proxy_pass http://nextjs_upstream;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /public {
        proxy_cache STATIC;
        proxy_pass http://nextjs_upstream;
        add_header Cache-Control "public, max-age=3600";
    }

    location /_next/webpack-hmr {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location / {
        limit_req zone=frontend_limit burst=20 nodelay;
        proxy_pass http://nextjs_upstream;
    }

    location /health {
        access_log off;
        proxy_pass http://nextjs_upstream;
    }
}
