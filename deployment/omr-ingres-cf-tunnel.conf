# LAYER 1: Ingress / Tunnel Endpoint
# Working configuration as of 2025-12-17
# Receives traffic from Cloudflare Tunnel (Port 8091)
# Forwards to Layer 2 (Unified Gateway)

upstream layer2_gateway {
    #server gt-omr-web.gt:80;
    server 10.10.24.151:80;
    keepalive 64;
}

server {
    listen 8091;
    server_name omr.gongtham.net;

    access_log /var/log/nginx/layer1-ingress.access.log;
    error_log /var/log/nginx/layer1-ingress.error.log warn;

    # 1. Handling Large Uploads at Ingress
    client_max_body_size 500M;

    location / {
        proxy_pass http://layer2_gateway;

        # Proxy Headers - Pass original client info
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade"; # Needed for Websockets

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; # Force HTTPS semantics from Tunnel

        # Timeouts - Must be > Layer 2 timeouts
        proxy_connect_timeout 75s;
        proxy_read_timeout 3600s;

        # Disable buffering to allow streaming through ingress
        proxy_request_buffering off;
        proxy_buffering off;

        # Increase buffer size for headers only (not body)
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}
